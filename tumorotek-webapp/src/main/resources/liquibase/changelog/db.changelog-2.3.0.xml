<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" 
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">
    
    <changeSet id="${project.artifactId}-1" author="MB" context="*">
        <tagDatabase tag="${project.parent.version}"/>
    </changeSet>
    <changeSet id="${project.artifactId}-2" author="MB" runAlways="true" context="*">
    	<comment>Gastbi prelevement nature peut être nulle</comment>
       	<dropNotNullConstraint tableName="PRELEVEMENT" columnName="NATURE_ID" columnDataType="int"/>
    </changeSet>
    <changeSet id="${project.artifactId}-3" author="MB" runAlways="true" context="*">
    	<comment>Gastbi prelevement statut juridique peut être nul</comment>
       	<dropNotNullConstraint tableName="PRELEVEMENT" columnName="CONSENT_TYPE_ID" columnDataType="int"/>
    </changeSet>
    <changeSet id="${project.artifactId}-4" author="MB" runAlways="true" context="*">
    	<comment>Gastbi échantillon type peut être nul</comment>
       	<dropNotNullConstraint tableName="ECHANTILLON" columnName="ECHANTILLON_TYPE_ID" columnDataType="int"/>
    </changeSet>
    <changeSet id="${project.artifactId}-5" author="MB" runAlways="true" context="*"> 
    	<preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">SELECT COUNT(1) FROM CHAMP_ENTITE
                WHERE NOM = 'CongDepart'
            </sqlCheck>
        </preConditions>
        <comment>Ajout champ entite prélévement congelé site préleveur</comment>
        <insert tableName="CHAMP_ENTITE">
            <column name="CHAMP_ENTITE_ID" value="269"/>
            <column name="NOM" value="CongDepart"/>
             <column name="DATA_TYPE_ID" value="2" />
            <column name="IS_NULL" value="1"/>
            <column name="IS_UNIQUE" value="0"/>
            <column name="ENTITE_ID" value="2"/>
            <column name="CAN_IMPORT" value="0"/>
        </insert>
    </changeSet>
    <changeSet id="${project.artifactId}-6" author="MB" runAlways="true" context="*"> 
    	<preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">SELECT COUNT(1) FROM CHAMP_ENTITE
                WHERE NOM = 'CongArrivee'
            </sqlCheck>
        </preConditions>
        <comment>Ajout champ entite prélévement congelé arrivee</comment>
        <insert tableName="CHAMP_ENTITE">
            <column name="CHAMP_ENTITE_ID" value="270"/>
            <column name="NOM" value="CongArrivee"/>
            <column name="DATA_TYPE_ID" value="2" />
            <column name="IS_NULL" value="1"/>
            <column name="IS_UNIQUE" value="0"/>
            <column name="ENTITE_ID" value="2"/>
            <column name="CAN_IMPORT" value="0"/>
        </insert>
    </changeSet>
    <changeSet id="${project.artifactId}-7" author="MB" runAlways="true" context="*">
    	<comment>Gastbi patient nom peut être nul</comment>
       	<dropNotNullConstraint tableName="PATIENT" columnName="NOM" columnDataType="varchar(50)"/>
    </changeSet>
    <changeSet id="${project.artifactId}-8" author="MB" runAlways="true" context="*">
    	<comment>Gastbi patient nip peut être nul</comment>
       	<dropNotNullConstraint tableName="PATIENT" columnName="NIP" columnDataType="varchar(20)"/>
    </changeSet>
    <changeSet id="${project.artifactId}-9" author="MB" runAlways="true" context="*">
    	<comment>Gastbi patient etat peut être nul</comment>
       	<dropNotNullConstraint tableName="PATIENT" columnName="PATIENT_ETAT" columnDataType="char(10)"/>
    </changeSet>
    <changeSet id="${project.artifactId}-20" author="CH" runAlways="true" context="*"> 
    	<preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">SELECT COUNT(1) FROM CHAMP_ENTITE
                WHERE NOM = 'CodeOrganes' and ENTITE_ID=2
            </sqlCheck>
        </preConditions>
        <comment>Ajout champ entite prélévement Organes en plus de celui présent côté échantillon pour un besoin Gatsbi</comment>
        <insert tableName="CHAMP_ENTITE">
            <column name="CHAMP_ENTITE_ID" value="271"/>
            <column name="NOM" value="CodeOrganes"/>
            <column name="DATA_TYPE_ID" value="1" />
            <column name="IS_NULL" value="1"/>
            <column name="IS_UNIQUE" value="0"/>
            <column name="ENTITE_ID" value="2"/>
            <column name="CAN_IMPORT" value="0"/>
        </insert>
    </changeSet>
  	<changeSet id="${project.artifactId}-21" author="CH" runAlways="true" context="*">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="CONFIG_ITEM"/>
            </not>
        </preConditions>
        <comment>Création de la table CONFIG_ITEM, qui permettra de gérer certaines conf en base de données : 
        	1er besoin la clé de sécurité permettant de générer le JWT pour communiquer avec Gatsbi
        </comment>
        <createTable tableName="CONFIG_ITEM">
            <column name="CLE" type="CHAR(15)">
                <constraints nullable="false"/>
            </column>
            <column name="VALEUR" type="VARCHAR(100)" />
        </createTable>
        <addPrimaryKey tableName="CONFIG_ITEM" columnNames="CLE"/>
    </changeSet>
 </databaseChangeLog>
