<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" 
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">
    
    <changeSet id="${project.artifactId}-1" author="MB" context="*">
        <tagDatabase tag="${project.parent.version}"/>
    </changeSet>
    <changeSet id="${project.artifactId}-2" author="MB" runAlways="true" context="*">
    	<comment>Gastbi prelevement nature peut être nulle</comment>
       	<dropNotNullConstraint tableName="PRELEVEMENT" columnName="NATURE_ID" columnDataType="int"/>
    </changeSet>
    <changeSet id="${project.artifactId}-3" author="MB" runAlways="true" context="*">
    	<comment>Gastbi prelevement statut juridique peut être nul</comment>
       	<dropNotNullConstraint tableName="PRELEVEMENT" columnName="CONSENT_TYPE_ID" columnDataType="int"/>
    </changeSet>
    <changeSet id="${project.artifactId}-4" author="MB" runAlways="true" context="*">
    	<comment>Gastbi échantillon type peut être nul</comment>
       	<dropNotNullConstraint tableName="ECHANTILLON" columnName="ECHANTILLON_TYPE_ID" columnDataType="int"/>
    </changeSet>
    <changeSet id="${project.artifactId}-5" author="MB" runAlways="true" context="*"> 
    	<preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">SELECT COUNT(1) FROM CHAMP_ENTITE
                WHERE NOM = 'congDepart'
            </sqlCheck>
        </preConditions>
        <comment>AJout champ entite prélévement congelé site préleveur</comment>
        <insert tableName="CHAMP_ENTITE">
            <column name="CHAMP_ENTITE_ID" value="269"/>
            <column name="NOM" value="congDepart"/>
             <column name="DATA_TYPE_ID" value="2" />
            <column name="IS_NULL" value="1"/>
            <column name="IS_UNIQUE" value="0"/>
            <column name="ENTITE_ID" value="2"/>
            <column name="CAN_IMPORT" value="0"/>
        </insert>
    </changeSet>
     <changeSet id="${project.artifactId}-6" author="MB" runAlways="true" context="*"> 
    	<preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">SELECT COUNT(1) FROM CHAMP_ENTITE
                WHERE NOM = 'congArrivee'
            </sqlCheck>
        </preConditions>
        <comment>AJout champ entite prélévement congelé arrivee</comment>
        <insert tableName="CHAMP_ENTITE">
            <column name="CHAMP_ENTITE_ID" value="270"/>
            <column name="NOM" value="congArrivee"/>
            <column name="DATA_TYPE_ID" value="2" />
            <column name="IS_NULL" value="1"/>
            <column name="IS_UNIQUE" value="0"/>
            <column name="ENTITE_ID" value="2"/>
            <column name="CAN_IMPORT" value="0"/>
        </insert>
    </changeSet>
    <changeSet id="${project.artifactId}-7" author="MB" runAlways="true" context="*"> 
    	<preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">SELECT COUNT(1) FROM CONTEXTE
                WHERE NOM = 'GATSBI'
            </sqlCheck>
        </preConditions>
        <comment>Ajout contexte nommé GATBSI</comment>
        <insert tableName="CONTEXTE">
        	<column name="CONTEXTE_ID" value="4"/>
            <column name="NOM" value="GATSBI"/>
            <column name="LIBELLE" value="Gatsbi"/>
        </insert>
    </changeSet>
  	<changeSet id="${project.artifactId}-8" author="MB" runAlways="true" context="*">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="GATSBI_ETUDE"/>
            </not>
        </preConditions>
        <comment>Création de la table GATSBI_ETUDE, si nécessaire, pour les tests principalement ou les installations 
        	qui n'utiliseraient pas GATSBi
        </comment>
        <createTable tableName="GATSBI_ETUDE">
            <column name="GATSBI_ETUDE_ID" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="TITRE" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="ACRONYME" type="VARCHAR(5)">
                <constraints nullable="false"/>
            </column>
            <column name="ARCHIVE" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
            <column name="PLATEFORME_ID" type="INT"/>
        </createTable>

        <addPrimaryKey tableName="GATSBI_ETUDE" columnNames="GATSBI_ETUDE_ID"/>
        <addForeignKeyConstraint constraintName="FK_GATSBI_ETUDE_PLATEFORME_ID" referencedTableName="PLATEFORME" baseColumnNames="PLATEFORME_ID" baseTableName="GATSBI_ETUDE"
                                 referencedColumnNames="PLATEFORME_ID"/>
    </changeSet>
   <changeSet id="${project.artifactId}-9" author="MBA" runAlways="true" context="*">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="BANQUE" columnName="GATSBI_ETUDE_ID"/>
            </not>
        </preConditions>
        <comment>Ajout de la référence BANQUE vers GATSBI_ETUDE_ID</comment>
        <addColumn tableName="BANQUE">
            <column name="GATSBI_ETUDE_ID" type="INT(100)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
        <addForeignKeyConstraint constraintName="FK_BANQUE_ETUDE_ID" referencedTableName="GATSBI_ETUDE" baseColumnNames="GATSBI_ETUDE_ID" baseTableName="BANQUE"
                                 referencedColumnNames="GATSBI_ETUDE_ID"/>
    </changeSet> 
</databaseChangeLog>
