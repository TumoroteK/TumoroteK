name: Build TK On Linux

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      # Set up Java 8
      - name: Set up JDK 8
        uses: actions/setup-java@v2
        with:
          java-version: '8'
          distribution: 'temurin'

     # Create Maven Wrapper
      - name: Create Maven Wrapper
        run: mvn wrapper:wrapper

      - name: Restore Maven cache
        uses: skjolber/maven-cache-github-action@v1
        with:
           step: restore
 
     # Install Missing JAR: Oracle JDBC
      - name: Install Oracle JDBC driver to local repository
        run: |
         wget -O ojdbc6-11.2.0.4.jar https://repo1.maven.org/maven2/com/oracle/database/jdbc/ojdbc6/11.2.0.4/ojdbc6-11.2.0.4.jar
         ./mvnw install:install-file -Dfile=ojdbc6-11.2.0.4.jar -DgroupId=oracle -DartifactId=ojdbc6 -Dversion=11.2.0.4 -Dpackaging=jar
         
     # Install Missing JAR: A dependency of Spring WS Security Â» 2.1.3.RELEASE
      - name: Download and install xws-security-1.3.1.jar
        run: |
          wget  -O com.sun.xml.wsit.xws-security-1.3.1.jar    https://repository.jboss.org/com/sun/xml/wsit/xws-security/1.3.1/xws-security-1.3.1.jar
          ./mvnw install:install-file -Dfile=com.sun.xml.wsit.xws-security-1.3.1.jar -DgroupId=com.sun.xml.wsit -DartifactId=xws-security -Dversion=1.3.1 -Dpackaging=jar   

      # Install Missing JAR: wsit-rt
      - name: Install wsit-rt to local repository
        run: |
          wget -O wsit-rt-1.1.jar https://repository.jboss.org/com/sun/xml/wsit/wsit-rt/1.1/wsit-rt-1.1.jar
          ./mvnw install:install-file -Dfile=wsit-rt-1.1.jar -DgroupId=com.sun.xml.wsit -DartifactId=wsit-rt -Dversion=1.1 -Dpackaging=jar 



      #The ZK dependencies in this project are of version 6.5.7: a version that can't be found in Maven Repo,
      #they  must be installed manually

      # Unzip the zip file with all the zk jars that have the groupIdD org.zkoss.common and install them
      - name: Unzip and Install org.zkoss.common JARs
        run: |
          mkdir -p unzip_temp_common
          unzip -q $GITHUB_WORKSPACE/.github/workflows/org.zkoss.common.zip -d unzip_temp_common
          for file in unzip_temp_common/*.jar; do
            filename=$(basename "$file")
            artifactId=$(echo "$filename" | sed 's/-6.5.7.jar//')
            echo "Installing file: $file   - GroupId: org.zkoss.common  - ArtifactId: $artifactId"
            ./mvnw install:install-file -Dfile=$file -DgroupId=org.zkoss.common -DartifactId=$artifactId -Dversion=6.5.7 -Dpackaging=jar
          done

        working-directory: ${{ github.workspace }}

        # Unzip the zip file with all the zk jars that have the groupIdD org.zkoss.zk and install them
      - name: Unzip and Install org.zkoss.zk JARs
        run: |
          mkdir -p unzip_temp_zk
          unzip -q $GITHUB_WORKSPACE/.github/workflows/org.zkoss.zk.zip -d unzip_temp_zk
          for file in unzip_temp_zk/*.jar; do
            filename=$(basename "$file")
            artifactId=$(echo "$filename" | sed 's/-6.5.7.jar//')
            echo "Installing file: $file"
            echo "  GroupId: org.zkoss.zk"
            echo "  ArtifactId: $artifactId"
            ./mvnw install:install-file -Dfile=$file -DgroupId=org.zkoss.zk -DartifactId=$artifactId -Dversion=6.5.7 -Dpackaging=jar
          done

        working-directory: ${{ github.workspace }}

      # Print the folders and subfolders of the specified directory
      - name: Print folders and subfolders
        run: |
          echo "Folders and subfolders of /home/runner/.m2/repository:"
          ls -R /home/runner/.m2/repository

      # Compile the project using Maven Wrapper
      - name: Clean
        run: ./mvnw clean

      # Compile the project using Maven Wrapper
      - name: Compile with Maven Wrapper
        run: ./mvnw install -DskipTests

#      # Save Maven Cache
#      - name: Save Maven cache
#        uses: skjolber/maven-cache-github-action@v1
#        with:
#         step: save
